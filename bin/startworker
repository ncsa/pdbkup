#!/bin/bash

[[ -z "$PDBKUP_BASE" ]] && exit 1

[[ $BKUP_DEBUG -gt 0 ]] && set -x

source $PDBKUP_BASE/lib/funcs.sh
source $PDBKUP_BASE/lib/read_ini.sh

read_ini $PDBKUP_BASE/conf/settings.ini
[[ $BKUP_DEBUG -gt 0 ]] && dump_ini

# Dont continue if active parallel or dar processes
parcount=$( pgrep -f parallel | wc -l )
[[ $parcount -ne 0 ]] && die "Existing parallel processes found, exiting."
darcount=$( pgrep -f dar | wc -l )
[[ $darcount -ne 0 ]] && die "Existing dar processes found, exiting."

# Get a sqlworker cmdfile
cmdfile=$( next_worker_cmdfile )
echo "CMDFILE: $cmdfile"
if [[ "${#cmdfile}" -gt 0 ]] ; then
    echo "bash $cmdfile" | at now
else
    warn "Nothing to do"
fi
