#!/bin/bash

[[ $DEBUG -gt 0 ]] && set -x

source lib/funcs.sh
source lib/read_ini.sh

read_ini conf/settings.cfg
dump_ini


# CREATE COMMON DIRECTORY VARS
par_srcdir="$INI__GENERAL__DATADIR/$INI__PAR__SRCDIR"
par_workdir="$INI__GENERAL__DATADIR/$INI__PAR__WORKDIR"
par_enddir="$INI__GENERAL__DATADIR/$INI__PAR__ENDDIR"

# OTHER COMMON VARS
cmdfile_ext="cmd"


# VERIFY PAR COMMAND
PAR=$INI__PAR__CMD
[[ -z "$PAR" ]] && PAR=$(which par2)
[[ -f "$PAR" ]] || die "par cmd '$PAR' does not exist"
[[ -x "$PAR" ]] || die "par cmd '$PAR' is not executable"

# DETERMINE IF MORE PARS CAN RUN
cur_par_count=$( find "$par_workdir" -mindepth 1 -name "*.$cmdfile_ext" | wc -l )
num_pars_to_start=$( bc <<< "$INI__PAR__CONCURRENCY - $cur_par_count" )
if [[ $num_pars_to_start -gt 0 ]]; then
    srcfiles=( $( find "$par_srcdir" -mindepth 1 | head -n $num_pars_to_start ) )
fi
for srcfile in "${srcfiles[@]}"; do
    srcfn=$(basename "$srcfile")
    par_infile="$par_workdir/$srcfn"
    cmdfile="$par_workdir/${srcfn}.$cmdfile_ext"
    logfile="$par_workdir/${srcfn}.log"
    errfile="$par_workdir/${srcfn}.err"
    pidfile="$par_workdir/${srcfn}.pid"
    # CREATE PAR CMD SCRIPT
    (
        b=$(which bash)
        echo "#!$b"
        echo '('
        echo "mv \"$srcfile\" \"$par_infile\""
        echo 'start_time=$( date "+%s" )'
        echo "$PAR create -d $par_workdir -r $INI__PAR__REDUNDANCY -n 1 -t+ \"$par_infile\""
        echo 'exitcode=$?'
        echo 'end_time=$( date "+%s" )'
        echo 'elapsed_secs=$( bc <<< "$end_time - $start_time" )'
        echo "srcsz=\$( stat --printf=\"%s\" \"$par_infile\" )"
        echo 'rate_bps=$( bc <<< "$srcsz / $elapsed_secs" )'
        echo "echo PAR SRC \"$par_infile\""
        echo 'echo PAR SRC_SIZE $srcsz'
        echo 'echo PAR START $start_time'
        echo 'echo PAR END $end_time'
        echo 'echo PAR ELAPSED $elapsed_secs'
        echo 'echo PAR RATE_BPS $rate_bps'
        echo 'echo PAR EXITCODE $exitcode'
#        echo 'if [[ $exitcode -eq 0 ]]; then '
#        echo '    mv '
#        echo 'fi'
        echo 'exit $exitcode'
        echo ") 1>\"$logfile\" 2>\"$errfile\""
    ) > "$cmdfile"

    # RUN PAR CMDFILE
    set -x
    bash "$cmdfile" &
    echo $! > "$pidfile"
    set +x
done
